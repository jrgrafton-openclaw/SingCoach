default_platform(:ios)

platform :ios do
  before_all do
    setup_ci if ENV['CI']
  end

  private_lane :api_key do
    key_path = ENV['APP_STORE_CONNECT_API_KEY_PATH'] ||
               File.expand_path("~/.openclaw/secrets/app-store-connect/AuthKey_7UKLD4C2CC.p8")
    app_store_connect_api_key(
      key_id: ENV['APP_STORE_CONNECT_KEY_ID'] || "7UKLD4C2CC",
      issuer_id: ENV['APP_STORE_CONNECT_ISSUER_ID'] || "69a6de70-79a7-47e3-e053-5b8c7c11a4d1",
      key_filepath: File.expand_path(key_path),
      in_house: false
    )
  end

  lane :beta do
    api_key

    # Unlock the no-password build keychain
    sh "security unlock-keychain -p '' ~/Library/Keychains/build.keychain-db"
    sh "security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k '' ~/Library/Keychains/build.keychain-db 2>/dev/null || true"
    sh "security list-keychains -d user -s ~/Library/Keychains/build.keychain-db ~/Library/Keychains/login.keychain-db /Library/Keychains/System.keychain"

    increment_build_number(xcodeproj: "SingCoach.xcodeproj")

    build_app(
      project: "SingCoach.xcodeproj",
      scheme: "SingCoach",
      export_method: "app-store",
      clean: true,
      output_directory: "./build",
      output_name: "SingCoach.ipa"
    )

    ipa_path = File.expand_path("../build/SingCoach.ipa", __dir__)
    key_path = ENV['APP_STORE_CONNECT_API_KEY_PATH'] ||
               File.expand_path("~/.openclaw/secrets/app-store-connect/AuthKey_7UKLD4C2CC.p8")
    key_id   = ENV['APP_STORE_CONNECT_KEY_ID']    || "7UKLD4C2CC"
    issuer   = ENV['APP_STORE_CONNECT_ISSUER_ID'] || "69a6de70-79a7-47e3-e053-5b8c7c11a4d1"
    sh %Q{
      KEY_CONTENT=$(cat #{File.expand_path(key_path)})
      cat > /tmp/asc_api_key.json << EOF
{
  "key_id": "#{key_id}",
  "issuer_id": "#{issuer}",
  "key": $(echo "$KEY_CONTENT" | jq -Rs .),
  "duration": 1200,
  "in_house": false
}
EOF
      fastlane pilot upload --ipa "#{ipa_path}" \
        --skip_waiting_for_build_processing \
        --api-key-path /tmp/asc_api_key.json
    }

    build_number = get_build_number(xcodeproj: "SingCoach.xcodeproj")
    version_number = get_version_number(xcodeproj: "SingCoach.xcodeproj", target: "SingCoach")

    add_git_tag(tag: "v#{version_number}-build#{build_number}")
    push_git_tags
    git_commit(
      path: ["SingCoach.xcodeproj/project.pbxproj"],
      message: "[ci skip] Bump build to #{build_number}"
    )
    push_to_git_remote
  end
end
