default_platform(:ios)

platform :ios do
  before_all do
    setup_ci if ENV['CI']
    # Lesson #11: altool crashes with "invalid byte sequence in US-ASCII" without this
    ENV['LC_ALL'] = 'en_US.UTF-8'
    ENV['LANG']   = 'en_US.UTF-8'
  end

  private_lane :api_key do
    key_path = File.expand_path("~/.openclaw/secrets/app-store-connect/AuthKey_7UKLD4C2CC.p8")
    app_store_connect_api_key(
      key_id: "7UKLD4C2CC",
      issuer_id: "69a6de70-79a7-47e3-e053-5b8c7c11a4d1",
      key_filepath: key_path,
      in_house: false
    )
  end

  private_lane :create_json_key do
    key_path = File.expand_path("~/.openclaw/secrets/app-store-connect/AuthKey_7UKLD4C2CC.p8")
    key_content = File.read(key_path)
    require 'json'
    json = JSON.generate({
      "key_id" => "7UKLD4C2CC",
      "issuer_id" => "69a6de70-79a7-47e3-e053-5b8c7c11a4d1",
      "key" => key_content,
      "duration" => 1200,
      "in_house" => false
    })
    File.write("/tmp/asc_api_key.json", json)
    "/tmp/asc_api_key.json"
  end

  lane :beta do
    api_key

    # Unlock the no-password build keychain and grant codesign access.
    # set-key-partition-list MUST complete before xcodebuild starts — otherwise
    # GatherProvisioningInputs hangs waiting for keychain access.
    sh "security unlock-keychain -p '' ~/Library/Keychains/build.keychain-db"
    sh "security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k '' ~/Library/Keychains/build.keychain-db 2>/dev/null || true"
    sh "security list-keychains -d user -s ~/Library/Keychains/build.keychain-db ~/Library/Keychains/login.keychain-db /Library/Keychains/System.keychain"

    # Create JSON key file for tools that need it
    json_key_path = create_json_key

    # Download App Store provisioning profile (no force: re-uses cached profile unless expired)
    sigh(
      app_identifier: "com.jrgrafton.singcoach",
      api_key_path: json_key_path,
      output_path: "./fastlane"
    )

    # Install provisioning profile
    profile_path = lane_context[SharedValues::SIGH_PROFILE_PATH]
    profile_uuid = lane_context[SharedValues::SIGH_UUID]
    sh "cp '#{profile_path}' ~/Library/MobileDevice/Provisioning\\ Profiles/#{profile_uuid}.mobileprovision"

    # Switch to manual signing using the downloaded profile
    update_code_signing_settings(
      use_automatic_signing: false,
      path: "SingCoach.xcodeproj",
      profile_uuid: profile_uuid,
      bundle_identifier: "com.jrgrafton.singcoach",
      code_sign_identity: "Apple Distribution: james grafton"
    )

    # Build number is managed in Info.plist directly (CFBundleVersion).
    # We read the current value and increment it. Info.plist is the source of truth —
    # immune to xcodegen resets because Info.plist is committed to git with the correct value.
    project_root = File.expand_path("..", __dir__)
    info_plist_path = "#{project_root}/SingCoach/Info.plist"
    current_build = sh("/usr/libexec/PlistBuddy -c 'Print CFBundleVersion' '#{info_plist_path}'", log: false).strip.to_i
    next_build = current_build + 1
    UI.message("Incrementing build: #{current_build} → #{next_build}")
    sh "/usr/libexec/PlistBuddy -c 'Set CFBundleVersion #{next_build}' '#{info_plist_path}'"

    # Build phase: archive with CODE_SIGNING_ALLOWED=NO to skip GatherProvisioningInputs
    # network hang. Signing happens at export time using the profile we already downloaded.
    archive_path = "/Users/familybot/Library/Developer/Xcode/Archives/#{Time.now.strftime('%Y-%m-%d')}/SingCoach.xcarchive"
    sh %Q{
      cd '#{project_root}'
      xcodebuild \
        -scheme SingCoach \
        -project SingCoach.xcodeproj \
        -destination 'generic/platform=iOS' \
        -archivePath '#{archive_path}' \
        -parallelizeTargets \
        COMPILER_INDEX_STORE_ENABLE=NO \
        ENABLE_BITCODE=NO \
        SKIP_CRASHLYTICS_DSYM_UPLOAD=1 \
        archive > /tmp/xcodebuild-archive.log 2>&1 || (tail -50 /tmp/xcodebuild-archive.log >&2; exit 1)
    }

    # Export phase: sign and package the IPA
    export_options_path = "/tmp/SingCoach_export_options.plist"
    File.write(export_options_path, <<~PLIST)
      <?xml version="1.0" encoding="UTF-8"?>
      <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
      <plist version="1.0">
      <dict>
        <key>method</key>
        <string>app-store-connect</string>
        <key>teamID</key>
        <string>B5X96QDRF4</string>
        <key>uploadSymbols</key>
        <true/>
        <key>compileBitcode</key>
        <false/>
        <key>signingStyle</key>
        <string>manual</string>
        <key>signingCertificate</key>
        <string>Apple Distribution: james grafton</string>
        <key>provisioningProfiles</key>
        <dict>
          <key>com.jrgrafton.singcoach</key>
          <string>#{profile_uuid}</string>
        </dict>
      </dict>
      </plist>
    PLIST

    build_output = File.expand_path("../build", __dir__)
    FileUtils.mkdir_p(build_output)
    sh %Q{
      xcodebuild \
        -exportArchive \
        -archivePath '#{archive_path}' \
        -exportPath '#{build_output}' \
        -exportOptionsPlist '#{export_options_path}'
    }

    ipa_path = Dir.glob(File.expand_path("../build/*.ipa", __dir__)).first ||
               File.expand_path("../build/SingCoach.ipa", __dir__)
    dsym_path = File.expand_path("#{archive_path}/dSYMs/SingCoach.app.dSYM")

    # Upload dSYM to Firebase Crashlytics.
    # dSYM is a directory inside the xcarchive — find upload-symbols from DerivedData.
    if File.exist?(dsym_path)
      UI.message("Uploading dSYM to Firebase Crashlytics...")
      upload_symbols_binary = Dir.glob(
        File.expand_path("~/Library/Developer/Xcode/DerivedData/SingCoach-*/SourcePackages/checkouts/firebase-ios-sdk/Crashlytics/upload-symbols")
      ).first
      if upload_symbols_binary
        sh "#{upload_symbols_binary} -gsp '#{project_root}/SingCoach/GoogleService-Info.plist' -p ios '#{dsym_path}'" rescue UI.important("⚠️  dSYM upload failed — upload manually via Firebase Console if needed")
      else
        UI.important("⚠️  upload-symbols binary not found in DerivedData — skipping dSYM upload")
      end
    end

    key_path = File.expand_path(ENV['APP_STORE_CONNECT_API_KEY_PATH'] || "~/.openclaw/secrets/app-store-connect/AuthKey_7UKLD4C2CC.p8")
    key_id   = ENV['APP_STORE_CONNECT_KEY_ID']    || "7UKLD4C2CC"
    issuer   = ENV['APP_STORE_CONNECT_ISSUER_ID'] || "69a6de70-79a7-47e3-e053-5b8c7c11a4d1"

    # Upload IPA using altool via xcrun (faster than spawning a second fastlane process).
    # altool looks for the API key at ~/.appstoreconnect/private_keys/AuthKey_KEYID.p8 —
    # ensure ours is there (symlink so we don't duplicate the secret).
    UI.message("Uploading IPA to App Store Connect...")
    sh %Q{
      mkdir -p ~/.appstoreconnect/private_keys
      ln -sf "#{key_path}" ~/.appstoreconnect/private_keys/AuthKey_#{key_id}.p8
      xcrun altool --upload-app \
        --type ios \
        --file "#{ipa_path}" \
        --apiKey "#{key_id}" \
        --apiIssuer "#{issuer}" \
        --show-progress \
        2>&1 | grep -v "^$"
    }

    # IMPORTANT: pilot upload with --skip_waiting_for_build_processing uploads the IPA
    # but does NOT distribute to testers. pilot distribute also silently lies about success.
    # Use the ASC API directly to add the build to the Internal Testers beta group.
    # SingCoach Internal Testers group ID: 7b26e051-1109-4403-b4a3-86873cbf970e
    INTERNAL_GROUP_ID = "7b26e051-1109-4403-b4a3-86873cbf970e"
    APP_ID = "6759441600"
    # Poll until VALID (up to 15 minutes). 422 = still PROCESSING, so we MUST wait.
    UI.message("Waiting for ASC to finish processing build #{next_build} (polling up to 15 min)...")
    sh %Q{
      python3 - << 'PYEOF'
import jwt, time, urllib.request, json, sys, os

def make_token():
    key = open(os.path.expanduser("~/.openclaw/secrets/app-store-connect/AuthKey_7UKLD4C2CC.p8")).read()
    payload = {"iss": "69a6de70-79a7-47e3-e053-5b8c7c11a4d1", "iat": int(time.time()), "exp": int(time.time()) + 1200, "aud": "appstoreconnect-v1"}
    return jwt.encode(payload, key, algorithm="ES256", headers={"kid": "7UKLD4C2CC"})

def headers():
    return {"Authorization": f"Bearer {make_token()}", "Content-Type": "application/json"}

APP_ID = "6759441600"
GROUP_ID = "7b26e051-1109-4403-b4a3-86873cbf970e"
BUILD_VERSION = "#{next_build}"

# Poll until the build appears AND is VALID (not PROCESSING / INVALID)
build_id = None
for attempt in range(90):  # 90 x 10s = 15 minutes max
    url = f"https://api.appstoreconnect.apple.com/v1/apps/{APP_ID}/builds?limit=20&fields[builds]=version,processingState"
    req = urllib.request.Request(url, headers=headers())
    builds = json.loads(urllib.request.urlopen(req).read())["data"]
    match = next((b for b in builds if b["attributes"]["version"] == BUILD_VERSION), None)
    if match:
        state = match["attributes"]["processingState"]
        print(f"[{attempt+1}/90] Build {BUILD_VERSION}: {state}")
        if state == "VALID":
            build_id = match["id"]
            break
        elif state == "INVALID":
            print(f"ERROR: Build {BUILD_VERSION} is INVALID in ASC — cannot distribute", file=sys.stderr)
            sys.exit(1)
    else:
        print(f"[{attempt+1}/90] Build {BUILD_VERSION} not yet visible in ASC...")
    time.sleep(10)

if not build_id:
    print(f"ERROR: Build {BUILD_VERSION} never reached VALID after 15 minutes", file=sys.stderr)
    sys.exit(1)

print(f"✅ Build {BUILD_VERSION} is VALID: {build_id}")

# Add to Internal Testers group
payload_data = json.dumps({"data": [{"type": "builds", "id": build_id}]}).encode()
req = urllib.request.Request(
    f"https://api.appstoreconnect.apple.com/v1/betaGroups/{GROUP_ID}/relationships/builds",
    data=payload_data, headers=headers(), method="POST"
)
try:
    urllib.request.urlopen(req)
    print(f"✅ Build {BUILD_VERSION} added to Internal Testers — testers will be notified")
except urllib.error.HTTPError as e:
    body = e.read().decode()
    # 409 = already in group (fine), anything else = real error
    if e.code == 409:
        print(f"ℹ️  Build {BUILD_VERSION} was already in the Internal Testers group")
    else:
        print(f"ERROR {e.code} adding to beta group: {body}", file=sys.stderr)
        sys.exit(1)

# Verify
time.sleep(3)
url2 = f"https://api.appstoreconnect.apple.com/v1/betaGroups/{GROUP_ID}/builds?limit=5&fields[builds]=version,processingState"
req2 = urllib.request.Request(url2, headers=headers())
result = json.loads(urllib.request.urlopen(req2).read())
print("Builds now in Internal Testers group:")
for b in result["data"][:5]:
    print(f"  Build {b['attributes']['version']} — {b['attributes']['processingState']}")
PYEOF
    }

    build_number = next_build.to_s
    version_number = sh("/usr/libexec/PlistBuddy -c 'Print CFBundleShortVersionString' '#{info_plist_path}'", log: false).strip

    add_git_tag(tag: "v#{version_number}-build#{build_number}")
    push_git_tags
    git_commit(
      path: ["SingCoach.xcodeproj/project.pbxproj", "SingCoach/Info.plist"],
      message: "[ci skip] Bump build to #{build_number}",
      allow_nothing_to_commit: true
    )
    push_to_git_remote
  end
end
