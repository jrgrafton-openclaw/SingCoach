<?xml version="1.0" encoding="UTF-8"?>
<testsuites>
  <testsuite name="fastlane.lanes">
    
    
    
      
      <testcase classname="fastlane.lanes" name="00: default_platform" time="0.000189">
        
      </testcase>
    
      
      <testcase classname="fastlane.lanes" name="01: Switch to ios api_key lane" time="4.9e-05">
        
      </testcase>
    
      
      <testcase classname="fastlane.lanes" name="02: app_store_connect_api_key" time="0.007429">
        
      </testcase>
    
      
      <testcase classname="fastlane.lanes" name="03: security unlock-keychain -p &apos;&apos; ~/Library/Keychains/build.keychain-db" time="0.010382">
        
      </testcase>
    
      
      <testcase classname="fastlane.lanes" name="04: security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k &apos;&apos; ~/Library/Keychains/build.keychain-db 2&gt;/dev/null || true" time="0.025311">
        
      </testcase>
    
      
      <testcase classname="fastlane.lanes" name="05: security list-keychains -d user -s ~/Library/Keychains/build.keychain-db ~/Library/Keychains/login.keychain-db /Library/Keychains/System.keychain" time="0.007793">
        
      </testcase>
    
      
      <testcase classname="fastlane.lanes" name="06: Switch to ios create_json_key lane" time="0.000114">
        
      </testcase>
    
      
      <testcase classname="fastlane.lanes" name="07: sigh" time="4.599268">
        
      </testcase>
    
      
      <testcase classname="fastlane.lanes" name="08: cp &apos;/Users/familybot/.openclaw/workspace/projects/SingCoach/fastlane/AppStore_com.jrgrafton.singcoach.mobileprovision&apos; ~/Library/MobileDevice/Provisioning\ Profiles/80a1436e-d270-4dc6-916e-4a2065748d16.mobileprovision" time="0.005275">
        
      </testcase>
    
      
      <testcase classname="fastlane.lanes" name="09: update_code_signing_settings" time="0.02513">
        
      </testcase>
    
      
      <testcase classname="fastlane.lanes" name="10: shell command" time="0.006117">
        
      </testcase>
    
      
      <testcase classname="fastlane.lanes" name="11: /usr/libexec/PlistBuddy -c &apos;Set CFBundleVersion 43&apos; &apos;/Users/familybot/.openclaw/workspace/projects/SingCoach/SingCoach/Info.plist&apos;" time="0.005015">
        
      </testcase>
    
      
      <testcase classname="fastlane.lanes" name="12: build_app" time="85.098669">
        
      </testcase>
    
      
      <testcase classname="fastlane.lanes" name="13: 
      KEY_CONTENT=$(cat /Users/familybot/.openclaw/secrets/app-store-connect/AuthKey_7UKLD4C2CC.p8)
      cat &gt; /tmp/asc_api_key.json &lt;&lt; EOF
{
  &quot;key_id&quot;: &quot;7UKLD4C2CC&quot;,
  &quot;issuer_id&quot;: &quot;69a6de70-79a7-47e3-e053-5b8c7c11a4d1&quot;,
  &quot;key&quot;: $(echo &quot;$KEY_CONTENT&quot; | jq -Rs .),
  &quot;duration&quot;: 1200,
  &quot;in_house&quot;: false
}
EOF
      fastlane pilot upload --ipa &quot;/Users/familybot/.openclaw/workspace/projects/SingCoach/build/SingCoach.ipa&quot;         --skip_waiting_for_build_processing         --app_identifier &quot;com.jrgrafton.singcoach&quot;         --api-key-path /tmp/asc_api_key.json
    " time="47.935475">
        
      </testcase>
    
      
      <testcase classname="fastlane.lanes" name="14: 
      python3 - &lt;&lt; &apos;PYEOF&apos;
import jwt, time, urllib.request, json, sys, os

def make_token():
    key = open(os.path.expanduser(&quot;~/.openclaw/secrets/app-store-connect/AuthKey_7UKLD4C2CC.p8&quot;)).read()
    payload = {&quot;iss&quot;: &quot;69a6de70-79a7-47e3-e053-5b8c7c11a4d1&quot;, &quot;iat&quot;: int(time.time()), &quot;exp&quot;: int(time.time()) + 1200, &quot;aud&quot;: &quot;appstoreconnect-v1&quot;}
    return jwt.encode(payload, key, algorithm=&quot;ES256&quot;, headers={&quot;kid&quot;: &quot;7UKLD4C2CC&quot;})

def headers():
    return {&quot;Authorization&quot;: f&quot;Bearer {make_token()}&quot;, &quot;Content-Type&quot;: &quot;application/json&quot;}

APP_ID = &quot;6759441600&quot;
GROUP_ID = &quot;7b26e051-1109-4403-b4a3-86873cbf970e&quot;
BUILD_VERSION = &quot;43&quot;

# Poll until the build appears AND is VALID (not PROCESSING / INVALID)
build_id = None
for attempt in range(90):  # 90 x 10s = 15 minutes max
    url = f&quot;https://api.appstoreconnect.apple.com/v1/apps/{APP_ID}/builds?limit=20&amp;fields[builds]=version,processingState&quot;
    req = urllib.request.Request(url, headers=headers())
    builds = json.loads(urllib.request.urlopen(req).read())[&quot;data&quot;]
    match = next((b for b in builds if b[&quot;attributes&quot;][&quot;version&quot;] == BUILD_VERSION), None)
    if match:
        state = match[&quot;attributes&quot;][&quot;processingState&quot;]
        print(f&quot;[{attempt+1}/90] Build {BUILD_VERSION}: {state}&quot;)
        if state == &quot;VALID&quot;:
            build_id = match[&quot;id&quot;]
            break
        elif state == &quot;INVALID&quot;:
            print(f&quot;ERROR: Build {BUILD_VERSION} is INVALID in ASC — cannot distribute&quot;, file=sys.stderr)
            sys.exit(1)
    else:
        print(f&quot;[{attempt+1}/90] Build {BUILD_VERSION} not yet visible in ASC...&quot;)
    time.sleep(10)

if not build_id:
    print(f&quot;ERROR: Build {BUILD_VERSION} never reached VALID after 15 minutes&quot;, file=sys.stderr)
    sys.exit(1)

print(f&quot;✅ Build {BUILD_VERSION} is VALID: {build_id}&quot;)

# Add to Internal Testers group
payload_data = json.dumps({&quot;data&quot;: [{&quot;type&quot;: &quot;builds&quot;, &quot;id&quot;: build_id}]}).encode()
req = urllib.request.Request(
    f&quot;https://api.appstoreconnect.apple.com/v1/betaGroups/{GROUP_ID}/relationships/builds&quot;,
    data=payload_data, headers=headers(), method=&quot;POST&quot;
)
try:
    urllib.request.urlopen(req)
    print(f&quot;✅ Build {BUILD_VERSION} added to Internal Testers — testers will be notified&quot;)
except urllib.error.HTTPError as e:
    body = e.read().decode()
    # 409 = already in group (fine), anything else = real error
    if e.code == 409:
        print(f&quot;ℹ️  Build {BUILD_VERSION} was already in the Internal Testers group&quot;)
    else:
        print(f&quot;ERROR {e.code} adding to beta group: {body}&quot;, file=sys.stderr)
        sys.exit(1)

# Verify
time.sleep(3)
url2 = f&quot;https://api.appstoreconnect.apple.com/v1/betaGroups/{GROUP_ID}/builds?limit=5&amp;fields[builds]=version,processingState&quot;
req2 = urllib.request.Request(url2, headers=headers())
result = json.loads(urllib.request.urlopen(req2).read())
print(&quot;Builds now in Internal Testers group:&quot;)
for b in result[&quot;data&quot;][:5]:
    print(f&quot;  Build {b[&apos;attributes&apos;][&apos;version&apos;]} — {b[&apos;attributes&apos;][&apos;processingState&apos;]}&quot;)
PYEOF
    " time="131.56857">
        
      </testcase>
    
      
      <testcase classname="fastlane.lanes" name="15: shell command" time="0.015459">
        
      </testcase>
    
      
      <testcase classname="fastlane.lanes" name="16: add_git_tag" time="0.031253">
        
      </testcase>
    
      
      <testcase classname="fastlane.lanes" name="17: push_git_tags" time="1.009405">
        
      </testcase>
    
      
      <testcase classname="fastlane.lanes" name="18: git_commit" time="0.044748">
        
      </testcase>
    
      
      <testcase classname="fastlane.lanes" name="19: push_to_git_remote" time="0.734564">
        
      </testcase>
    
  </testsuite>
</testsuites>
